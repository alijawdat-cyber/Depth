# PRE-EXECUTION REPORT — Depth Email System Audit (READ-ONLY)

> **التاريخ:** 2025-01-17  
> **النطاق:** depth-agency.com  
> **الهدف:** تدقيق شامل بدون تعديلات فعلية  
> **الحالة:** مكتمل - بانتظار موافقة المالك للتنفيذ

---

## 1) حالة Workspace الحالية

### المستخدمون والمجموعات
- **المستخدمون:** 1 (`admin@depth-agency.com`)
- **المجموعات:** 9 مجموعات بريد نشطة
- **العضوية:** admin@ هو المالك/المدير لجميع المجموعات
- **الأعضاء:** مجموعة واحدة لكل مجموعة (admin@ فقط)

### المجموعات المنشأة
- ✅ `hello@depth-agency.com` - الواجهة العامة
- ✅ `sales@depth-agency.com` - المبيعات والمتابعة  
- ✅ `support@depth-agency.com` - الدعم الفني
- ✅ `press@depth-agency.com` - الإعلام والعلاقات العامة
- ✅ `billing@depth-agency.com` - محاسبة ومدفوعات
- ✅ `invoices@depth-agency.com` - فواتير
- ✅ `legal@depth-agency.com` - الشؤون القانونية  
- ✅ `studio@depth-agency.com` - الإنتاج الداخلي
- ✅ `jobs@depth-agency.com` - طلبات التوظيف

### ملاحظات مهمة
⚠️ **تحتاج ضبط:** جميع المجموعات تحتاج تفعيل Collaborative Inbox للعمل التشاركي  
⚠️ **سياسات الرد:** تحتاج ضبط `replyTo` للمجموعات الداخلية vs الخارجية

---

## 2) حالة DNS وأمان البريد الإلكتروني

### سجلات DNS الحالية
| السجل | الحالة | القيمة |
|-------|---------|--------|
| **MX** | ✅ صحيح | `1 smtp.google.com.` |
| **SPF** | ✅ صحيح | `v=spf1 include:_spf.google.com ~all` |
| **DKIM** | ✅ مفعّل | 2048-bit `google._domainkey` |
| **DMARC** | ⚠️ قابل للتحسين | `p=quarantine` |

### توصيات DMARC
- **الحالة الحالية:** `p=quarantine` - مقبولة للبداية
- **المقترح:** مراقبة تقارير DMARC لمدة أسبوعين
- **الخطوة التالية:** ترقية إلى `p=reject` عند التأكد من نظافة التسليم

---

## 3) تحليل الموقع والكود

### نقاط الإرسال الحالية

#### 1. نموذج التواصل (`/api/contact`)
- **الملف:** `depth-site/src/app/api/contact/route.ts`
- **المرسل:** `Depth <hello@depth-agency.com>`
- **المستقبل:** 
  - `admin@depth-agency.com`
  - `hello@depth-agency.com`
- **مزود الإرسال:** Resend
- **المشكلة:** جميع الرسائل تذهب لنفس الوجهات

#### 2. نموذج الحجز (`/book`)
- **الملف:** `depth-site/src/components/pages/BookClient.tsx`
- **الحالة:** نموذج front-end فقط
- **المشكلة:** لا يوجد إرسال بريد فعلي

### فحص الصفحات
- ✅ **robots.txt:** موجود ومضبوط
- ✅ **sitemap.xml:** يعمل بشكل صحيح
- ✅ **صفحات رئيسية:** `/` `/about` `/contact` `/blog` تعمل
- ✅ **النماذج:** موجودة ولكن تحتاج توجيه ذكي

---

## 4) خريطة التوجيه (Current vs Proposed)

### الوضع الحالي
```
جميع النماذج → admin@ + hello@
(بدون تمييز حسب نوع الاستفسار)
```

### المقترح
```
استفسارات التسعير → sales@depth-agency.com
مشاكل تقنية → support@depth-agency.com  
طلبات العمل → jobs@depth-agency.com
الإعلام → press@depth-agency.com
افتراضي → hello@depth-agency.com
نسخة → admin@depth-agency.com (للجميع)
```

### آلية التوجيه المقترحة
1. **Dropdown selector** في نموذج التواصل
2. **كشف الكلمات المفتاحية** للتوجيه الذكي
3. **CC إلى admin@** لجميع الرسائل

---

## 5) المخاطر وخطة الرجوع

### مخاطر منخفضة
- تفعيل Collaborative Inbox (قابل للإلغاء)
- ضبط سياسات الرد للمجموعات (قابل للتراجع)

### مخاطر متوسطة  
- تعديل نموذج التواصل (يحتاج اختبار دقيق)
- ترقية DMARC إلى `p=reject` (قد يؤثر على التسليم)

### خطة الرجوع لكل تغيير
1. **Collaborative Inbox:** `gam update group X settings enableCollaborativeInbox false`
2. **سياسات الرد:** إعادة إلى `REPLY_TO_SENDER` للجميع
3. **نموذج التواصل:** `git revert` للكود السابق
4. **DMARC:** إعادة إلى `p=quarantine` في حال مشاكل التسليم

### النسخ الاحتياطية
- ✅ جميع إعدادات المجموعات محفوظة في `audits/preexec/group_*.txt`
- ✅ DNS records موثقة في `audits/preexec.log`
- ✅ كود الموقع في Git مع commit history

---

## 6) الخطوات التالية (بموافقة المالك فقط)

### Phase 1: إعدادات Google Workspace (30 دقيقة)
- [ ] تفعيل Collaborative Inbox لـ hello@ و support@
- [ ] ضبط سياسات `replyTo` للمجموعات الداخلية/الخارجية
- [ ] اختبار الإرسال والاستقبال

### Phase 2: تطوير نموذج التواصل (2-3 ساعات)
- [ ] إضافة dropdown لنوع الاستفسار
- [ ] تنفيذ Router function للتوجيه الذكي
- [ ] اختبار شامل وdeploy

### Phase 3: قوالب البريد المتقدمة (1-2 ساعات)
- [ ] تفعيل auto-reply للمجموعات الرئيسية
- [ ] إضافة رقم واتساب في جميع القوالب
- [ ] اختبار التجربة من end-to-end

### Phase 4: مراقبة وتحسين DMARC (أسبوعين)
- [ ] مراقبة تقارير DMARC على dmarc@depth-agency.com
- [ ] تحليل معدل التسليم والرفض
- [ ] ترقية إلى `p=reject` عند التأكد

---

## 7) الملفات والمخرجات

### الملفات المنشأة في هذا التدقيق
```
audits/
├── preexec.log              - سجل التدقيق الكامل
├── preexec/
│   ├── users.tsv           - قائمة المستخدمين
│   ├── groups.tsv          - قائمة المجموعات  
│   ├── group_members.tsv   - عضويات المجموعات
│   ├── aliases.tsv         - البريد المستعار
│   ├── group_*.txt         - إعدادات كل مجموعة
│   ├── code_scan.txt       - فحص الكود للبريد
│   └── site_scan.txt       - فحص الموقع
├── MAPPING.json            - خريطة التوجيه current/proposed
├── EMAIL_TEMPLATES_PREVIEW.md - معاينة قوالب البريد
├── PRE-EXEC-REPORT.md      - هذا التقرير
└── READY-TO-APPLY.sh       - أوامر التنفيذ (معلقة)
```

---

## 8) الخلاصة والتوصيات

### ✅ النقاط الإيجابية
- Domain verified وGoogle Workspace مضبوط بشكل صحيح
- DNS records (MX/SPF/DKIM) تعمل بكفاءة
- جميع المجموعات المطلوبة منشأة ونشطة
- الموقع والـ API يعملان بدون مشاكل

### ⚠️ النقاط التي تحتاج تحسين
- توجيه البريد الحالي غير مخصص (كله يذهب لنفس المكان)
- المجموعات تحتاج Collaborative Inbox للعمل التشاركي
- نماذج الموقع تحتاج توجيه ذكي
- DMARC قابل للترقية لحماية أفضل

### 🎯 الأولويات
1. **عاجل:** تفعيل Collaborative Inbox لـ hello@ و support@
2. **مهم:** تطوير التوجيه الذكي في نموذج التواصل
3. **مستقبلي:** ترقية DMARC وإضافة قوالب البريد المتقدمة

---

**✨ النتيجة:** النظام جاهز للترقية، لا توجد مشاكل حرجة، والتحسينات المقترحة ستحسن كثيراً من تجربة العميل وكفاءة الفريق.

**🔄 الخطوة التالية:** مراجعة هذا التقرير مع صاحب المشروع والموافقة على Phase 1 للبدء.
