# 🔐 سياسة إدارة المفاتيح (Key Management Policy) - Depth V2.0

## 1. النطاق
تشمل: مفاتيح API، أسرار Webhooks، رموز الخدمة، مفاتيح التشفير، توكنات النشر.

## 2. المبادئ
- أقل صلاحية (Least Privilege)
- فصل البيئات (Isolation)
- دوران دوري (Rotation)
- تجنب التخزين في المستودع (No Inline Secrets)

## 3. أنواع المفاتيح
| النوع | الاستخدام | التخزين | الدوران | المراقبة |
|-------|----------|---------|---------|----------|
| Firebase Admin Key | وظائف سيرفر | Vercel / Secret Manager (مستقبلاً) | نصف سنوي | Logs الوصول |
| Vercel Token | نشر | GitHub Secrets | ربع سنوي | مراجعة PR |
| Webhook Signing Secret | تحقق سلامة | Firestore (مشفر) | عند الشك / سنوي | عد فشل التوقيع |
| Encryption Key (AES-256) | تشفير حقول حساسة | KMS مستقبلاً / متغير مبدئي | سنوي | مراقبة استخدام | 
| Service Account JSON | تفاعل خلفي | Encrypted Secret | نصف سنوي | وصول وظيفي |

## 4. دورة حياة السر (Secret Lifecycle)
1. إنشاء (Generate)
2. توزيع آمن (Store & Scope)
3. استخدام (Access Logging)
4. دوران (Rotate)
5. إبطال (Revoke)
6. إزالة (Dispose Securely)

## 5. التوليد (Generation)
استخدام `openssl rand -hex 32` أو أدوات رسمية (Console) — يمنع استخدام كلمات مرور بشرية.

## 6. الدوران (Rotation Procedure)
| خطوة | وصف |
|------|-----|
| 1 | توليد قيمة جديدة |
| 2 | إضافة إلى مخزن الأسرار (لا استبدال مباشر بعد) |
| 3 | تحديث التكوين في Staging واختبار |
| 4 | تبديل Production |
| 5 | إزالة القيمة القديمة بعد 24 ساعة (Grace) |
| 6 | تحديث سجل الدوران |

## 7. سجل الدوران (Rotation Log)
حقل مقترح في Firestore: `keyRotations/{id}`
```
{
  id, keyType, oldFingerprint, newFingerprint, rotatedBy, rotatedAt, graceEndsAt
}
```

## 8. بصمات (Fingerprints)
حفظ بصمة SHA256 للمفتاح بدلاً من قيمته كاملة للمرجع والتحقق.

## 9. الوصول (Access Control)
| الدور | السماح | القيود |
|-------|--------|--------|
| Admin | قراءة/إدارة | عبر لوحة تحكم آمنة |
| Developer | قراءة مفاتيح Dev فقط | لا وصول لمفاتيح الإنتاج |
| Auditor | قراءة بصمات وسجلات | بلا استخراج قيم |

## 10. المخاطر والتخفيف
| الخطر | الأثر | التخفيف |
|-------|-------|---------|
| تسرب مفتاح إنتاج | اختراق بيانات | تشفير + دوران سريع |
| مشاركة مفاتيح | صعوبة تتبع | فصل لكل خدمة |
| مفاتيح قديمة | ثغرات | سياسة دوران آلية |

## 11. الأتمتة المستقبلية
- [ ] اعتماد Managed KMS
- [ ] تنبيه Slack عند اقتراب موعد دوران
- [ ] فحص Secrets في PR (GitLeaks)

## 12. عدم الالتزام
أي تجاوز يرفع إلى مسؤول الأمن ويُوثق في سجل المخاطر.

> آخر تحديث: 2025-08-21
